var image_added;!function(d){var i,o,n,r,s,c;d(document).ready(function(){var e=d("#page_image_picker");c=e.data("input-type"),s="wym"==c,d("#custom_images_tab a").click(function(){if(!e.data("size-applied")&&s){var t=d(".page_part:first .wym_box"),a=d(".page_part:first iframe");e.css({height:t.height(),width:t.width()}).data("size-applied",!0).corner("tr 5px").corner("bottom 5px").find(".wym_box").css({backgroundColor:"white",height:a.height()+d(".page_part:first .wym_area_top").height()-parseInt(d(".wym_area_top .label_inline_with_link a").css("lineHeight")),width:a.width()-20,"border-color":a.css("border-top-color"),"border-style":a.css("border-top-style"),"border-width":a.css("border-top-width"),padding:"0px 10px 0px 10px"})}}),d("#page_images li textarea:hidden").each(function(t){var a=d(this).attr("name"),e=d(this);e.attr("data-old-id",e.attr("id")),e.attr("name","ignore_me_"+t),e.attr("id","ignore_me_"+t);var i=d("<input>").addClass("caption").attr("type","hidden").attr("name",a).attr("id",e.attr("data-old-id")).val(e.val());e.parents("li").first().append(i)}),i(),d(".page-images-caption-modal").hide(),r=d("#page_images .js-page-images-template").detach()}),i=function(){s&&WYMeditor.onload_functions.push(function(){d(".wym_box").css({width:null})}),d("#page_images").sortable({tolerance:"pointer",placeholder:"placeholder",cursor:"drag",items:"li",stop:n}),d("#page_images").on("mouseenter mouseleave","li",function(t){var a=d(this),e=a.find(".image_actions");if("mouseenter"==t.type){if(0==e.length){e=d("<div class='image_actions'></div>");var i=d("<img src='http://www.factorynis.com/assets/refinery/icons/delete-6fab9310cb7ca270fca3eb99395659c9fa4d673cec260aecd2c964ba7e4bcc68.png' width='16' height='16' />");if(i.appendTo(e),i.click(function(){d(this).parents("li").first().remove(),n()}),0<a.find("textarea.page_caption").length){var r=d("<img src='http://www.factorynis.com/assets/refinery/icons/user_comment-b812ae9617c513096bfc9687c586d3ef9946cc83cfb4585cf8789785c1b16722.png' width='16' height='16' class='caption' />");r.appendTo(e),r.click(o)}else e.addClass("no_captions");e.appendTo(a)}e.show()}else"mouseleave"==t.type&&e.hide()}),n()},image_added=function(t){var a=r.clone(),e=d(t).attr("id").replace("image_","");a.find("input:hidden:first").val(e),d("<img />").attr({title:d(t).attr("title"),alt:d(t).attr("alt"),src:d(t).attr("data-grid")}).appendTo(a),a.attr("id","image_"+e).removeClass("empty"),a.appendTo(d("#page_images")),i()},o=function(){var t=d(this).closest("li"),a=t.find(".page-images-caption-modal > textarea"),e=a.parent(),i={textarea:{width:400,height:"auto"},wym:{width:928,height:530}};e.find(".js-page-images-done").on("click",function(){e.dialog("close")});var r=function(){s&&a.data("wymeditor").update(),d("li.current_caption_list_item").removeClass("current_caption_list_item"),d("#"+a.attr("data-old-id")).val(a.val()),e.dialog("destroy")};t.addClass("current_caption_list_item"),e.dialog({title:"translation missing: rs.refinery.js.admin.page_images.add_caption",modal:!0,resizable:!1,autoOpen:!0,width:i[c].width,height:i[c].height,close:r}),s?a.addClass("wymeditor active_rotator_wymeditor widest").wymeditor(wymeditor_boot_options):a.show()},n=function(){d("#page_images li textarea:hidden").each(function(t,a){var e=d(a).attr("name").split("_");e[2]=""+t,d(a).attr("name",e.join("_")),d(a).attr("id",d(a).attr("id").replace(/_\d/,"_"+t)),d(a).attr("data-old-id",d(a).attr("data-old-id").replace(/_\d_/,"_"+t+"_").replace(/_\d/,"_"+t))}),d("#page_images li").each(function(e,t){d("input:hidden",t).each(function(){var t=d(this),a=t.attr("name").split("]");a[1]="["+e,t.attr("name",a.join("]")),t.attr("id",t.attr("id").replace(/_\d_/,"_"+e+"_").replace(/_\d/,"_"+e))})})}}(jQuery);